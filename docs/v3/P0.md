# P0 - 核心基础功能（最高优先级）

**目标**: 书签管理系统的核心数据层和基础UI框架

**开发周期**: 1周

---

## 1. 数据层实现

### 1.1 bookmarksStore 状态管理
- [x] 创建 `src/stores/bookmarksStore.js`
- [x] 实现基础 state 定义
  - [x] `bookmarks: []` - 三级分类树结构
  - [x] `pinnedBookmarks: []` - 固定书签数组
  - [x] `favoriteBookmarks: []` - 收藏书签数组
  - [x] `currentFirstLevel: null` - 当前一级分类ID
  - [x] `currentSecondLevel: null` - 当前二级分类ID
  - [x] `currentThirdLevel: null` - 当前三级分类ID
  - [x] `isLoading: false` - 加载状态
  - [x] `lastLoaded: null` - 最后加载时间

### 1.2 数据持久化
- [x] 实现 `loadBookmarks()` action
  - [x] 从 `chrome.storage.local['onetabs_bookmarks']` 读取数据
  - [x] 数据验证和错误处理
  - [x] 更新 `isLoading` 和 `lastLoaded` 状态
- [x] 实现 `saveBookmarks()` action
  - [x] 保存到 `chrome.storage.local['onetabs_bookmarks']`
  - [x] 错误处理和重试机制
- [x] 实现 `initializeWithDefaults()` action
  - [x] 首次运行时初始化默认分类
  - [x] 创建示例书签数据

---

## 2. 基础 Getters 实现

### 2.1 分类相关 getters
- [x] `getFirstLevelCategories` - 返回所有一级分类
- [x] `getSecondLevelCategories(firstLevelId)` - 返回指定一级分类下的二级分类
- [x] `getThirdLevelCategories(firstLevelId, secondLevelId)` - 返回三级分类
- [x] `getCategoryById(id)` - 根据ID获取分类（任意层级）

### 2.2 书签相关 getters
- [x] `getBookmarks(categoryPath)` - 返回指定分类路径下的书签
  - 参数: `{ first, second, third }`
- [x] `getPinnedBookmarks` - 返回所有固定书签
- [x] `getFavoriteBookmarks` - 返回所有收藏书签
- [x] `getTotalBookmarksCount` - 返回所有书签总数

---

## 3. 核心CRUD Actions

### 3.1 分类操作
- [x] `addFirstLevelCategory(category)` - 添加一级分类
  - [x] 生成唯一ID
  - [x] 添加到 bookmarks 数组
  - [x] 调用 saveBookmarks() 持久化
- [x] `addSecondLevelCategory(firstLevelId, category)` - 添加二级分类
  - [x] 查找父级分类
  - [x] 添加到 children 数组
  - [x] 保存数据
- [x] `addThirdLevelCategory(firstLevelId, secondLevelId, category)` - 添加三级分类
  - [x] 查找父级分类
  - [x] 添加到 children 数组
  - [x] 保存数据
- [x] `updateCategory(categoryId, updates)` - 更新分类
  - [x] 递归查找目标分类
  - [x] 更新字段（名称、图标、颜色）
  - [x] 保存数据
- [x] `deleteCategory(categoryId)` - 删除分类
  - [x] 递归查找并删除
  - [x] 删除所有子分类和书签
  - [x] 保存数据

### 3.2 书签操作
- [x] `addBookmark(categoryPath, bookmark)` - 添加书签
  - [x] 生成唯一ID
  - [x] 添加 createdAt 时间戳
  - [x] 获取 favIconUrl
  - [x] 添加到指定分类
  - [x] 保存数据
- [x] `updateBookmark(bookmarkId, updates)` - 更新书签
  - [x] 递归查找书签
  - [x] 更新字段
  - [x] 保存数据
- [x] `deleteBookmark(bookmarkId)` - 删除书签
  - [x] 递归查找并删除
  - [x] 如果在固定/收藏列表中也删除
  - [x] 保存数据

### 3.3 固定功能
- [x] `pinBookmark(bookmark)` - 固定书签
  - [x] 添加到 pinnedBookmarks 数组
  - [x] 更新书签的 pinned 字段
  - [x] 保存数据
- [x] `unpinBookmark(bookmarkId)` - 取消固定
  - [x] 从 pinnedBookmarks 移除
  - [x] 更新书签的 pinned 字段
  - [x] 保存数据

---

## 4. 工具函数

### 4.1 URL工具 (urlValidator.js)
- [x] 创建 `src/utils/urlValidator.js`
- [x] `isValidUrl(url)` - 验证URL是否有效
  - [x] 只允许 http/https 协议
  - [x] 使用 try-catch 包裹 new URL()
- [x] `formatUrl(url)` - 格式化URL
  - [x] 自动添加 https:// 前缀
- [x] `extractDomain(url)` - 提取域名
- [x] `getSiteName(url)` - 获取网站名称
- [x] `getFavIconUrl(url)` - 获取网站图标URL
  - [x] 使用 Google Favicon API

---

## 5. 路由配置

### 5.1 添加书签路由
- [x] 编辑 `src/router/index.js`
- [x] 添加 `/bookmarks` 路由
  - [x] 路径: `/bookmarks`
  - [x] 名称: `Bookmarks`
  - [x] 组件: `BookmarksView`（懒加载）
  - [x] 元信息: `{ title: 'OneTabs - 书签导航' }`
- [x] 修改默认重定向到 `/bookmarks`

---

## 6. 数据结构定义

### 6.1 TypeScript类型定义（或JSDoc）
- [ ] 创建 `src/types/bookmarks.d.ts` 或使用 JSDoc
- [ ] 定义 `BookmarkCategory` 接口
  ```javascript
  {
    id: string
    name: string
    icon?: string
    color?: string
    children?: BookmarkCategory[]
    bookmarks?: Bookmark[]
  }
  ```
- [ ] 定义 `Bookmark` 接口
  ```javascript
  {
    id: string
    name: string
    url: string
    description?: string
    favIconUrl?: string
    tags?: string[]
    sourceGroup?: string
    createdAt: number
    visitCount: number
    pinned?: boolean
    favorite?: boolean
  }
  ```

---

## 7. 错误处理

### 7.1 数据验证
- [ ] `validateBookmarksData(data)` - 验证书签数据格式
  - [ ] 检查必填字段
  - [ ] 检查数据类型
  - [ ] 检查嵌套结构
  - [ ] 返回验证结果和错误信息
- [ ] 在 loadBookmarks 中集成数据验证
- [ ] 在 saveBookmarks 前进行数据验证

### 7.2 错误日志
- [ ] 使用现有的 errorHandler.js 记录错误
- [ ] 在所有 try-catch 块中记录错误日志
- [ ] 提供用户友好的错误提示

---

## 验收标准

- [x] bookmarksStore 所有 state、getters、actions 实现完成
- [x] 数据能正确保存到和读取自 chrome.storage.local
- [x] 三级分类的增删改查功能正常
- [x] 书签的增删改查功能正常
- [x] 固定书签功能正常
- [x] URL验证和格式化工具正常工作
- [x] 书签路由可以正常访问（即使页面为空）
- [ ] 所有代码通过 ESLint 检查
- [ ] 关键函数有单元测试或手动测试通过

---

**依赖**: 无（P0是基础，不依赖其他功能）

**后续**: P0完成后，可以并行开发 P1（UI层）和 P2（高级功能）
