# P2 - 高级功能（中优先级）

**目标**: 书签导入、搜索、收藏、批量操作等高级功能

**开发周期**: 2-3周

**前置依赖**: P0 + P1（基础功能已完成）

https://dribbble.com/shots/19753283-Web-Music-Player-Concept

---

## 1. Chrome书签导入 ✅

### 1.1 bookmarkImporter 工具 ✅

- [x] 创建 `src/utils/bookmarkImporter.js` ✅
- [x] HTML文件解析函数 ✅
  - [x] `parseGoogleBookmarks(htmlContent)` - 解析Chrome导出的HTML ✅
  - [x] 使用 DOMParser 解析HTML ✅
  - [x] 递归遍历 `<DL>` 标签（文件夹）✅
  - [x] 提取 `<H3>` 标签（文件夹名称）✅
  - [x] 提取 `<A>` 标签（书签链接）✅
  - [x] 提取书签属性（HREF, ADD_DATE, ICON）✅
  - [x] 构建三级分类树结构 ✅
  - [x] 超过三层的扁平化处理 ✅
- [x] chrome.bookmarks API集成 ✅
  - [x] `importFromChromeApi()` - 使用Chrome API导入 ✅
  - [x] 调用 `chrome.bookmarks.getTree()` ✅
  - [x] 递归遍历书签树 ✅
  - [x] `convertBookmarkTree(nodes, level)` - 转换为插件格式 ✅
  - [x] 处理文件夹和书签项 ✅
- [x] 数据格式转换 ✅
  - [x] 浏览器格式 → 插件三级分类格式 ✅
  - [x] 生成唯一ID ✅
  - [x] 设置默认图标和颜色 ✅
  - [x] 添加来源标识（`sourceGroup: 'Chrome导入'`）✅

### 1.2 ImportBookmarks 组件 ✅

- [x] 创建 `src/components/ImportBookmarks.vue` ✅
- [x] 导入对话框UI ✅
  - [x] 标题："导入Chrome书签" ✅
  - [x] 导入方式选择 ✅
    - [x] 选项1：上传HTML文件 ✅
    - [x] 选项2：从浏览器读取（chrome.bookmarks API）✅
  - [x] 文件选择器（原生input）✅
  - [x] 导入模式选择 ✅
    - [x] 合并模式：保留现有书签，追加新书签 ✅
    - [x] 替换模式：清空现有书签，导入新书签 ✅
  - [x] 操作指引文本 ✅
    - [x] 导出Chrome书签的步骤说明 ✅
- [x] 进度显示 ✅
  - [x] 使用 PrimeVue ProgressBar ✅
  - [x] 显示导入进度 ✅
- [x] 导入结果报告 ✅
  - [x] 成功导入的书签数 ✅
  - [x] 新增分类数 ✅
  - [x] 重复书签数（已跳过）✅
- [x] 错误处理 ✅
  - [x] HTML格式错误提示 ✅
  - [x] API调用失败提示 ✅

### 1.3 bookmarksStore 导入actions ✅

- [x] `importBookmarks(importedBookmarks)` ✅
  - [x] 调用 parseGoogleBookmarks() 或 importFromChromeApi() 解析 ✅
  - [x] 根据 mergeMode 合并或替换数据 ✅
  - [x] 保存到 chrome.storage ✅
  - [x] 返回导入统计 ✅
- [x] `mergeBookmarks(currentData, importedData, mode)` - 在 bookmarkImporter.js 中实现 ✅
  - [x] 检测重复书签（URL相同）✅
  - [x] 合并分类（名称相同则合并）✅
  - [x] 保留现有数据的优先级 ✅

### 1.4 manifest.json 权限 ✅

- [x] 添加 `bookmarks` 权限到 `src/assets/manifest.json` ✅

```json
{
  "permissions": ["tabs", "storage", "tabGroups", "activeTab", "bookmarks"]
}
```

---

## 2. 书签搜索功能 ✅

### 2.1 BookmarkSearchBar 组件 ✅

- [x] 创建 `src/components/BookmarkSearchBar.vue` ✅
- [x] 搜索框UI ✅
  - [x] 输入框（原生input）✅
  - [x] 搜索图标（pi-search）✅
  - [x] 清空按钮（pi-times）✅
  - [x] 占位符："搜索书签名称、URL、标签..." ✅
  - [x] 高级筛选按钮 ✅
- [x] 实时搜索 ✅
  - [x] 输入时触发搜索 ✅
  - [x] 清空时恢复默认视图 ✅
- [x] 搜索建议下拉 ✅
  - [x] 显示前5个匹配结果 ✅
  - [x] 关键词高亮显示 ✅
  - [x] 显示分类路径 ✅
  - [x] 快速打开按钮 ✅
- [x] 快捷键 ✅
  - [x] Ctrl/Cmd + F 聚焦搜索框 ✅
  - [x] Esc 清空搜索 ✅
  - [x] Enter 打开第一个结果 ✅

### 2.2 searchBookmarks getter ✅

- [x] 在 bookmarksStore 中实现 ✅
- [x] `searchBookmarks(keyword)` - 全文搜索 ✅
  - [x] 搜索范围：书签名称、URL、描述、标签 ✅
  - [x] 不区分大小写 ✅
  - [x] 返回匹配的书签数组（包含分类路径）✅
  - [x] 高亮匹配关键词 ✅

### 2.3 搜索结果展示 ✅

- [x] 在 BookmarksView 中集成 BookmarkSearchBar ✅
- [x] 显示搜索结果列表 ✅
  - [x] 书签卡片展示 ✅
  - [x] 显示所属分类路径（面包屑）✅
  - [x] 匹配关键词高亮显示 ✅
- [x] 高级筛选功能 ✅
  - [x] 按标签筛选 ✅
  - [x] 仅显示收藏 ✅
  - [x] 仅显示固定 ✅
- [x] 无结果提示 ✅
  - [x] 提示："未找到匹配的书签" ✅

---

## 3. 书签收藏功能 ✅（已实现基础功能）

### 3.1 收藏状态管理 ✅

- [x] bookmarksStore 中实现 ✅
- [x] `favoriteBookmark(bookmarkId)` action ✅
  - [x] 添加到 favoriteBookmarks 数组 ✅
  - [x] 更新书签的 isFavorite 字段为 true ✅
  - [x] 保存数据 ✅
- [x] `unfavoriteBookmark(bookmarkId)` action ✅
  - [x] 从 favoriteBookmarks 移除 ✅
  - [x] 更新书签的 isFavorite 字段为 false ✅
  - [x] 保存数据 ✅
- [x] `findBookmarkById(bookmarkId)` - 辅助方法 ✅
- [ ] Toast提示（在View层实现）
- [ ] `reorderFavoriteBookmarks(newOrder)` action
  - [ ] 更新 favoriteBookmarks 数组顺序
  - [ ] 保存数据

### 3.2 FavoriteBookmarksSection 组件

- [ ] 创建 `src/components/FavoriteBookmarksSection.vue`
- [ ] 收藏区域UI
  - [ ] 标题栏："⭐ 收藏的书签 (8)"
  - [ ] 展开/收起按钮
  - [ ] 书签网格展示
  - [ ] "查看全部收藏" 按钮（超过最大显示数量时）
- [ ] 折叠状态
  - [ ] 从 settingsStore 读取 `favoriteDefaultExpanded`
  - [ ] 点击展开/收起切换状态
  - [ ] 保存状态到 settingsStore
- [ ] 拖拽排序
  - [ ] 使用 Sortable.js 或原生拖拽
  - [ ] 拖拽时显示占位符
  - [ ] 拖拽结束调用 reorderFavoriteBookmarks()

### 3.3 BookmarkCard 收藏功能

- [ ] 添加收藏按钮（⭐图标）
  - [ ] 未收藏：空心星标
  - [ ] 已收藏：实心星标
- [ ] 点击切换收藏状态
  - [ ] 调用 favoriteBookmark() 或 unfavoriteBookmark()
  - [ ] Toast通知
- [ ] 右键菜单添加收藏选项

### 3.4 设置项

- [ ] 在 settingsStore 中添加收藏相关设置
- [ ] `showFavoriteSection: true` - 是否显示收藏区域
- [ ] `favoriteDefaultExpanded: true` - 收藏区域默认展开
- [ ] `favoriteMaxDisplay: 8` - 最大显示数量（4-20）
- [ ] `favoriteViewMode: 'grid'` - 展示模式（'grid' | 'list'）
- [ ] 在 Settings 页面添加收藏设置UI

---

## 4. 批量操作功能

### 4.1 多选模式

- [ ] 在 BookmarksView 中添加多选模式
- [ ] 工具栏
  - [ ] "批量管理" 按钮（开启多选模式）
  - [ ] 多选模式下显示："已选择 X 项"
  - [ ] "全选" 按钮
  - [ ] "取消" 按钮（退出多选模式）
- [ ] BookmarkCard 多选状态
  - [ ] 左上角显示复选框
  - [ ] 选中时卡片高亮
  - [ ] 点击卡片切换选中状态
- [ ] 批量操作栏
  - [ ] 底部固定操作栏
  - [ ] "批量删除" 按钮
  - [ ] "批量移动" 按钮
  - [ ] "批量添加到收藏集" 按钮
  - [ ] "批量收藏" 按钮

### 4.2 批量操作actions

- [ ] `batchDeleteBookmarks(bookmarkIds)` - 批量删除
  - [ ] 确认对话框："确定删除选中的 X 个书签吗？"
  - [ ] 循环删除所有书签
  - [ ] 从固定/收藏列表中移除
  - [ ] 保存数据
  - [ ] Toast提示："已删除 X 个书签"
- [ ] `batchMoveBookmarks(bookmarkIds, targetCategoryPath)` - 批量移动
  - [ ] 弹出分类选择对话框
  - [ ] 循环移动所有书签
  - [ ] 保存数据
  - [ ] Toast提示："已移动 X 个书签到 [分类名]"
- [ ] `batchFavoriteBookmarks(bookmarkIds)` - 批量收藏
  - [ ] 循环添加到收藏
  - [ ] 保存数据
  - [ ] Toast提示："已收藏 X 个书签"

### 4.3 CategorySelector 组件

- [ ] 创建 `src/components/CategorySelector.vue`
- [ ] 级联选择器UI
  - [ ] 使用 PrimeVue Cascader 组件
  - [ ] 显示三级分类树
  - [ ] 选择目标分类
- [ ] 在批量移动时使用

---

## 5. 浏览器书签同步

### 5.1 bookmarkSyncManager 工具

- [ ] 创建 `src/utils/bookmarkSyncManager.js`
- [ ] `fetchBrowserBookmarks()` - 获取浏览器书签
  - [ ] 调用 chrome.bookmarks.getTree()
  - [ ] 提供文件夹选择功能
  - [ ] 返回浏览器书签树
- [ ] `syncToBrowser(mode, options)` - 同步到浏览器
  - [ ] mode: 'full' 完全覆盖 | 'incremental' 增量同步
  - [ ] 完全覆盖模式：
    - [ ] 清空浏览器书签（保留根节点）
    - [ ] 根据三级分类创建文件夹
    - [ ] 添加所有书签
  - [ ] 增量同步模式：
    - [ ] 对比差异
    - [ ] 只同步新增和修改的项
- [ ] `compareBrowserBookmarks()` - 对比差异
  - [ ] 比较插件书签和浏览器书签
  - [ ] 返回：新增、更新、删除的项
- [ ] `convertPluginFormatToBrowserTree()` - 格式转换
  - [ ] 插件三级分类 → 浏览器文件夹树

### 5.2 BrowserSyncDialog 组件

- [ ] 创建 `src/components/BrowserSyncDialog.vue`
- [ ] "从浏览器获取" 功能
  - [ ] 检测浏览器书签数量
  - [ ] 显示书签文件夹树（可勾选）
  - [ ] 选择获取模式：全部导入 | 选择文件夹
  - [ ] 选择合并策略：覆盖 | 合并 | 创建新分类
  - [ ] 进度条显示
  - [ ] 获取结果报告
- [ ] "同步到浏览器" 功能
  - [ ] 显示同步警告
  - [ ] 选择同步模式：完全覆盖 | 增量同步
  - [ ] 选择同步范围（书签数据、分类结构、收藏状态）
  - [ ] 显示同步计划（新增、更新、删除的项）
  - [ ] 进度条显示
  - [ ] 同步结果报告
- [ ] 错误处理
  - [ ] API权限不足提示
  - [ ] 部分失败显示失败列表
  - [ ] 重试功能

### 5.3 bookmarksStore 同步actions

- [ ] `fetchBrowserBookmarks(options)` - 从浏览器获取
  - [ ] 调用工具函数获取数据
  - [ ] 根据合并策略处理数据
  - [ ] 保存到本地
  - [ ] 返回统计结果
- [ ] `syncToBrowser(mode, options)` - 同步到浏览器
  - [ ] 调用工具函数执行同步
  - [ ] 更新同步状态
  - [ ] 保存同步时间
  - [ ] 返回同步结果
- [ ] `compareBrowserBookmarks()` - 对比差异
  - [ ] 获取浏览器书签
  - [ ] 调用工具函数对比
  - [ ] 返回差异报告
- [ ] 同步状态管理
  - [ ] `syncStatus: 'idle' | 'syncing' | 'success' | 'error'`
  - [ ] `lastSyncTime: null`

### 5.4 自动同步（可选）

- [ ] 在 settingsStore 中添加同步设置
  - [ ] `enableBrowserSync: false` - 启用浏览器同步
  - [ ] `autoSyncInterval: 0` - 自动同步间隔（分钟，0=禁用）
  - [ ] `syncOnBookmarkChange: false` - 书签修改时自动同步
  - [ ] `syncDirection: 'to-browser'` - 同步方向
  - [ ] `conflictResolution: 'keep-plugin'` - 冲突解决策略
- [ ] 实现自动同步定时任务
  - [ ] 使用 setInterval 定时触发
  - [ ] 检查同步间隔设置
  - [ ] 执行同步操作
- [ ] 监听书签变化
  - [ ] 在 bookmarksStore 中监听数据变化
  - [ ] 如果 syncOnBookmarkChange 为 true，触发同步
- [ ] 监听浏览器书签变化（可选）
  - [ ] chrome.bookmarks.onCreated
  - [ ] chrome.bookmarks.onChanged
  - [ ] chrome.bookmarks.onRemoved
  - [ ] 双向同步支持

---

## 6. 高级过滤功能

### 6.1 FilterPanel 组件

- [ ] 创建 `src/components/FilterPanel.vue`
- [ ] 过滤选项
  - [ ] 按标签过滤（MultiSelect）
  - [ ] 按来源过滤（Dropdown）
  - [ ] 按日期范围过滤（DatePicker）
  - [ ] 按访问次数排序
- [ ] 过滤逻辑
  - [ ] 组合过滤条件
  - [ ] 实时更新书签列表
- [ ] 重置按钮
  - [ ] 清除所有过滤条件
  - [ ] 恢复默认视图

### 6.2 bookmarksStore 过滤getters

- [ ] `getBookmarksByTag(tag)` - 按标签筛选
- [ ] `getBookmarksBySource(source)` - 按来源筛选
- [ ] `getBookmarksByDateRange(startDate, endDate)` - 按日期筛选
- [ ] `sortBookmarksByVisitCount()` - 按访问次数排序

---

## 7. 数据导出功能

### 7.1 导出选项

- [ ] 在 Settings 页面添加导出功能
- [ ] 导出为JSON
  - [ ] 调用 bookmarksStore.exportToJson()
  - [ ] 下载 `onetabs-bookmarks-{timestamp}.json`
- [ ] 导出为HTML（可选）
  - [ ] 生成Chrome书签HTML格式
  - [ ] 可直接导入Chrome浏览器

### 7.2 bookmarksStore 导出actions

- [ ] `exportToJson(filename)` - 导出JSON
  - [ ] 获取所有书签数据
  - [ ] 添加元数据（版本、导出时间）
  - [ ] 调用 dataExporter.exportToJson()
- [ ] `exportToHtml(filename)` - 导出HTML（可选）
  - [ ] 生成Chrome书签HTML格式
  - [ ] 递归生成文件夹和书签标签
  - [ ] 下载文件

---

## 8. 设置页面扩展

### 8.1 书签设置项

- [ ] 在 Settings.vue 中添加"书签设置"选项卡
- [ ] 视图设置
  - [ ] 书签默认视图：网格视图 | 列表视图
  - [ ] 固定栏最大显示数量：5-20
- [ ] 图标设置
  - [ ] 书签图标获取方式：Google Favicon | 本地缓存
- [ ] 显示设置
  - [ ] 是否显示书签描述
  - [ ] 是否显示访问次数
  - [ ] 是否显示收藏区域
  - [ ] 收藏区域默认展开
  - [ ] 收藏最大显示数量
- [ ] 默认设置
  - [ ] 新建书签默认分类（Dropdown）
  - [ ] 书签排序方式：按名称 | 按创建时间 | 按访问次数 | 手动排序
- [ ] 浏览器同步设置
  - [ ] 启用浏览器同步
  - [ ] 自动同步间隔
  - [ ] 书签修改时自动同步
  - [ ] 同步方向
  - [ ] 冲突解决策略

### 8.2 settingsStore 扩展

- [ ] 添加所有书签相关设置字段
- [ ] 实现加载和保存逻辑
- [ ] 提供默认值

---

## 9. 数据统计

### 9.1 统计信息

- [ ] 在 Settings → 数据管理中添加书签统计
- [ ] 统计项
  - [ ] 书签总数
  - [ ] 分类总数（一级、二级、三级）
  - [ ] 固定书签数
  - [ ] 收藏书签数
  - [ ] 存储空间使用情况（书签数据）
- [ ] 数据完整性检查
  - [ ] 检查无效URL
  - [ ] 检查损坏的数据结构
  - [ ] 提供修复工具

---

## 10. 性能优化

### 10.1 虚拟滚动

- [ ] 在书签列表较多时（>100）使用虚拟滚动
- [ ] 使用 PrimeVue VirtualScroller
- [ ] 优化渲染性能

### 10.2 图标缓存

- [ ] 实现 favIconUrl 缓存策略
- [ ] 避免重复获取相同域名的图标
- [ ] 定期清理过期缓存

### 10.3 搜索优化

- [ ] 搜索结果缓存
- [ ] 防抖优化
- [ ] 索引优化（如使用Lunr.js）

---

## 验收标准

- [ ] Chrome书签HTML导入功能正常
- [ ] chrome.bookmarks API导入功能正常
- [ ] 导入进度和结果报告正确显示
- [ ] 全局搜索功能正常，支持多字段搜索
- [ ] 搜索结果正确显示，关键词高亮
- [ ] 书签收藏功能正常
- [ ] 收藏区域展示和交互正常
- [ ] 批量操作功能完整（删除、移动、收藏）
- [ ] 多选模式交互流畅
- [ ] 浏览器书签同步功能正常
- [ ] 同步进度和结果报告正确
- [ ] 高级过滤功能正常
- [ ] 数据导出功能正常
- [ ] 设置页面书签选项完整
- [ ] 数据统计信息准确
- [ ] 性能优化效果明显（大量数据时）
- [ ] 所有功能支持亮色/暗色主题
- [ ] 无控制台错误或警告

---

**前置依赖**: P0 + P1

**后续**: P2完成后，书签管理系统功能完整，可以开始P3（增强功能）
