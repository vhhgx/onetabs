# TOTP éªŒè¯ç è®¡ç®—å·¥å…· - ä½¿ç”¨æŒ‡å—

## ğŸ“– ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [å‘½ä»¤è¡Œä½¿ç”¨](#å‘½ä»¤è¡Œä½¿ç”¨)
3. [ä»£ç é›†æˆ](#ä»£ç é›†æˆ)
4. [å®é™…åœºæ™¯](#å®é™…åœºæ™¯)

---

## å¿«é€Ÿå¼€å§‹

### 1. æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼

```bash
# è¿›å…¥ç›®å½•
cd 2fa/simple-totp

# è¿è¡Œæ¼”ç¤º
node demo.js
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
==================================================
TOTP éªŒè¯ç ç”Ÿæˆå™¨
==================================================

ğŸ“± å¯†é’¥: YH23545V2Q44CX7P
ğŸ”‘ å½“å‰éªŒè¯ç : 123456
â±ï¸  å‰©ä½™æœ‰æ•ˆæ—¶é—´: 25 ç§’

--- éªŒè¯æµ‹è¯• ---
è¾“å…¥éªŒè¯ç : 123456
éªŒè¯ç»“æœ: âœ… é€šè¿‡
```

### 2. æŸ¥çœ‹å®Œæ•´æµ‹è¯•

```bash
node test.js
```

ä¼šçœ‹åˆ°ï¼š
- âœ… éªŒè¯ç ç”Ÿæˆ
- âœ… éªŒè¯ç éªŒè¯
- âœ… å®æ—¶å€’è®¡æ—¶ï¼ˆæ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°ï¼‰

---

## å‘½ä»¤è¡Œä½¿ç”¨

### æ–¹å¼ 1ï¼šç”ŸæˆéªŒè¯ç 

```bash
node integration-example.js YH23545V2Q44CX7P
```

**è¾“å‡º**ï¼š
```
ğŸ”‘ éªŒè¯ç : 123456
â±ï¸  å‰©ä½™: 25 ç§’
```

### æ–¹å¼ 2ï¼šéªŒè¯éªŒè¯ç 

```bash
node integration-example.js YH23545V2Q44CX7P 123456
```

**è¾“å‡º**ï¼š
```
âœ… éªŒè¯é€šè¿‡
```

æˆ–

```
âŒ éªŒè¯å¤±è´¥
```

---

## ä»£ç é›†æˆ

### åœ¨ Vue 3 é¡¹ç›®ä¸­ä½¿ç”¨

#### 1. å¤åˆ¶æ–‡ä»¶

å°† `totp.js` å¤åˆ¶åˆ°ä½ çš„ Vue é¡¹ç›®ï¼š
```
your-project/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ totp.js  â† å¤åˆ¶è¿™ä¸ªæ–‡ä»¶
```

#### 2. åˆ›å»º Vue ç»„ä»¶

```vue
<template>
  <div class="totp-generator">
    <el-card>
      <template #header>
        <h3>TOTP éªŒè¯ç ç”Ÿæˆå™¨</h3>
      </template>

      <!-- è¾“å…¥å¯†é’¥ -->
      <el-input
        v-model="secret"
        placeholder="è¯·è¾“å…¥å¯†é’¥ï¼ˆå¦‚ï¼šYH23545V2Q44CX7Pï¼‰"
        style="margin-bottom: 20px"
      />

      <!-- æ˜¾ç¤ºéªŒè¯ç  -->
      <div class="code-display">
        <div class="code">{{ currentCode || '------' }}</div>
        <div class="timer">å‰©ä½™ {{ remainingSeconds }} ç§’</div>
      </div>

      <!-- éªŒè¯åŒºåŸŸ -->
      <el-divider>éªŒè¯</el-divider>
      <el-input
        v-model="inputCode"
        placeholder="è¾“å…¥éªŒè¯ç è¿›è¡ŒéªŒè¯"
        maxlength="6"
        style="margin-bottom: 10px"
      />
      <el-button type="primary" @click="verify">éªŒè¯</el-button>
    </el-card>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue'
import { ElMessage } from 'element-plus'
import { generateTOTP, verifyTOTP, getRemainingSeconds } from '@/utils/totp.js'

defineOptions({ name: 'TOTPGenerator' })

const secret = ref('YH23545V2Q44CX7P')
const currentCode = ref('')
const remainingSeconds = ref(30)
const inputCode = ref('')

let timer = null

// æ›´æ–°éªŒè¯ç 
const updateCode = () => {
  if (secret.value) {
    currentCode.value = generateTOTP(secret.value)
    remainingSeconds.value = getRemainingSeconds()
  }
}

// éªŒè¯
const verify = () => {
  if (!inputCode.value) {
    ElMessage.warning('è¯·è¾“å…¥éªŒè¯ç ')
    return
  }

  const isValid = verifyTOTP(inputCode.value, secret.value)

  if (isValid) {
    ElMessage.success('âœ… éªŒè¯é€šè¿‡ï¼')
  } else {
    ElMessage.error('âŒ éªŒè¯å¤±è´¥ï¼')
  }

  inputCode.value = ''
}

// å¯åŠ¨å®šæ—¶å™¨
onMounted(() => {
  updateCode()
  timer = setInterval(updateCode, 1000)
})

// æ¸…ç†å®šæ—¶å™¨
onUnmounted(() => {
  if (timer) clearInterval(timer)
})
</script>

<style scoped>
.totp-generator {
  max-width: 500px;
  margin: 20px auto;
}

.code-display {
  text-align: center;
  padding: 30px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  color: white;
}

.code {
  font-size: 48px;
  font-weight: bold;
  letter-spacing: 8px;
  font-family: 'Courier New', monospace;
}

.timer {
  margin-top: 10px;
  font-size: 18px;
  opacity: 0.9;
}
</style>
```

### åœ¨ Node.js / Express åç«¯ä½¿ç”¨

#### åˆ›å»º API æ¥å£

```javascript
// server.js
import express from 'express'
import { generateTOTP, verifyTOTP } from './totp.js'

const app = express()
app.use(express.json())

// API 1ï¼šç”ŸæˆéªŒè¯ç 
app.post('/api/totp/generate', (req, res) => {
  const { secret } = req.body

  if (!secret) {
    return res.status(400).json({
      success: false,
      message: 'ç¼ºå°‘å¯†é’¥'
    })
  }

  try {
    const code = generateTOTP(secret)
    res.json({
      success: true,
      data: { code }
    })
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'ç”Ÿæˆå¤±è´¥'
    })
  }
})

// API 2ï¼šéªŒè¯éªŒè¯ç 
app.post('/api/totp/verify', (req, res) => {
  const { secret, token } = req.body

  if (!secret || !token) {
    return res.status(400).json({
      success: false,
      message: 'ç¼ºå°‘å‚æ•°'
    })
  }

  try {
    const isValid = verifyTOTP(token, secret)
    res.json({
      success: isValid,
      message: isValid ? 'éªŒè¯é€šè¿‡' : 'éªŒè¯å¤±è´¥'
    })
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'éªŒè¯å¤±è´¥'
    })
  }
})

app.listen(3000, () => {
  console.log('âœ… æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:3000')
})
```

#### æµ‹è¯• API

```bash
# ç”ŸæˆéªŒè¯ç 
curl -X POST http://localhost:3000/api/totp/generate \
  -H "Content-Type: application/json" \
  -d '{"secret":"YH23545V2Q44CX7P"}'

# éªŒè¯éªŒè¯ç 
curl -X POST http://localhost:3000/api/totp/verify \
  -H "Content-Type: application/json" \
  -d '{"secret":"YH23545V2Q44CX7P","token":"123456"}'
```

---

## å®é™…åœºæ™¯

### åœºæ™¯ 1ï¼šæ›¿ä»£ Google Authenticator

å¦‚æœä½ ä¸æƒ³ç”¨æ‰‹æœº APPï¼Œå¯ä»¥ç”¨è¿™ä¸ªå·¥å…·ç›´æ¥ç”ŸæˆéªŒè¯ç ï¼š

```bash
# æŠŠå¯†é’¥ä¿å­˜ä¸‹æ¥
echo "YH23545V2Q44CX7P" > my-secret.txt

# æ¯æ¬¡éœ€è¦éªŒè¯ç æ—¶è¿è¡Œ
node integration-example.js $(cat my-secret.txt)
```

### åœºæ™¯ 2ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•

```javascript
// test-login.js
import { generateTOTP } from './totp.js'

async function autoLogin() {
  const secret = 'YH23545V2Q44CX7P'

  // 1. ç™»å½•ï¼ˆè´¦å·å¯†ç ï¼‰
  const loginResponse = await fetch('https://api.example.com/login', {
    method: 'POST',
    body: JSON.stringify({
      email: 'user@example.com',
      password: 'password123'
    })
  })

  // 2. è‡ªåŠ¨ç”Ÿæˆ 2FA éªŒè¯ç 
  const code = generateTOTP(secret)

  // 3. æäº¤ 2FA éªŒè¯ç 
  const verifyResponse = await fetch('https://api.example.com/verify-2fa', {
    method: 'POST',
    body: JSON.stringify({
      token: code
    })
  })

  console.log('âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸï¼')
}
```

### åœºæ™¯ 3ï¼šå¤šè´¦å·ç®¡ç†

```javascript
// multi-accounts.js
import { generateTOTP } from './totp.js'

const accounts = {
  'Gmail': 'SECRET1234567890',
  'GitHub': 'ABCDEFGHIJ123456',
  'AWS': 'YH23545V2Q44CX7P',
}

console.log('ğŸ“± å¤šè´¦å·éªŒè¯ç ï¼š\n')

for (const [name, secret] of Object.entries(accounts)) {
  const code = generateTOTP(secret)
  console.log(`${name.padEnd(10)} â†’ ${code}`)
}
```

**è¾“å‡º**ï¼š
```
ğŸ“± å¤šè´¦å·éªŒè¯ç ï¼š

Gmail      â†’ 123456
GitHub     â†’ 789012
AWS        â†’ 345678
```

---

## å¸¸è§é—®é¢˜

### Q1: éªŒè¯ç å’Œ Google Authenticator ä¸ä¸€æ ·ï¼Ÿ

**åŸå› **ï¼š
1. å¯†é’¥è¾“å…¥é”™è¯¯ï¼ˆæ£€æŸ¥å¤§å°å†™ï¼‰
2. ç³»ç»Ÿæ—¶é—´ä¸å‡†ï¼ˆè¯¯å·®è¶…è¿‡ 30 ç§’ï¼‰

**è§£å†³**ï¼š
```bash
# Windows åŒæ­¥ç³»ç»Ÿæ—¶é—´
w32tm /resync

# Linux/Mac åŒæ­¥ç³»ç»Ÿæ—¶é—´
sudo ntpdate -s time.nist.gov
```

### Q2: å¦‚ä½•åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Ÿ

è¿™ä¸ªå·¥å…·ä½¿ç”¨äº† Node.js çš„ `crypto` æ¨¡å—ï¼Œä¸èƒ½ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨ `speakeasy` åº“ï¼ˆæµè§ˆå™¨å…¼å®¹ï¼‰
2. æˆ–è€…æ­å»ºä¸€ä¸ªç®€å•çš„ API æœåŠ¡

### Q3: æ”¯æŒå“ªäº›å¯†é’¥æ ¼å¼ï¼Ÿ

åªæ”¯æŒ **Base32** ç¼–ç çš„å¯†é’¥ï¼Œä¾‹å¦‚ï¼š
- âœ… `JBSWY3DPEHPK3PXP`
- âœ… `YH23545V2Q44CX7P`
- âŒ `hello123` (ä¸æ˜¯ Base32)

---

## æ€»ç»“

### æ ¸å¿ƒ API

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `generateTOTP(secret)` | ç”Ÿæˆ 6 ä½éªŒè¯ç  | `generateTOTP('YH23545V2Q44CX7P')` |
| `verifyTOTP(token, secret)` | éªŒè¯éªŒè¯ç  | `verifyTOTP('123456', 'YH23545V2Q44CX7P')` |
| `getRemainingSeconds()` | è·å–å‰©ä½™æ—¶é—´ | `getRemainingSeconds()` |

### ä½¿ç”¨æµç¨‹

```
1. å‡†å¤‡å¯†é’¥ï¼ˆBase32 æ ¼å¼ï¼‰
   â†“
2. è°ƒç”¨ generateTOTP(secret)
   â†“
3. å¾—åˆ° 6 ä½éªŒè¯ç ï¼ˆæ¯ 30 ç§’å˜åŒ–ï¼‰
```

å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ğŸ‰
